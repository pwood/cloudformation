{
"AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Storage for website content.",
    "Resources": {
        "Frontend": {
            "Type": "AWS::S3::Bucket",
            "Properties": {                
                "BucketName": { "Fn::ImportValue": "BaseDomainName" },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                }
            }
        },
        "Data": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
                "BucketName": { "Fn::Sub": [ "data.${Domain}", { "Domain": { "Fn::ImportValue": "BaseDomainName" } } ] },
                "VersioningConfiguration": {
                    "Status": "Enabled"
                },
                "CorsConfiguration": {
                    "CorsRules": [
                        {
                            "AllowedMethods": [ "GET", "HEAD" ],
                            "AllowedOrigins": [
                                "localhost",
                                { "Fn::ImportValue": "BaseDomainName" },
                                { "Fn::Sub": [ "localhost.${Domain}", { "Domain": { "Fn::ImportValue": "BaseDomainName" } } ] }
                            ]
                        }
                    ]
                }
            }
        },
        "CloudFrontOAI": {
            "Type" : "AWS::CloudFront::CloudFrontOriginAccessIdentity",
            "Properties" : {
                "CloudFrontOriginAccessIdentityConfig" : {
                    "Comment": "CloudFront identity for restricting access to S3 buckets purely to CF principal."
                }
            }                            
        },    
        "FrontEndPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket" : { "Ref": "Frontend" },
                "PolicyDocument": {
                    "Version": "2008-10-17",
                    "Id": "PolicyForCloudFrontPrivateContent",
                    "Statement": [
                        {
                            "Sid": "1",
                            "Effect": "Allow",
                            "Principal": {
                                "CanonicalUser": { "Fn::GetAtt": [ "CloudFrontOAI", "S3CanonicalUserId" ] }
                            },
                            "Action": "s3:GetObject",
                            "Resource": { "Fn::Sub": [ "${Bucket}/*", { "Bucket": { "Fn::GetAtt": [ "Frontend", "Arn"] } } ] }
                        }
                    ]
                }
            }
        },
        "DataPolicy": {
            "Type": "AWS::S3::BucketPolicy",
            "Properties": {
                "Bucket" : { "Ref": "Data" },
                "PolicyDocument": {
                    "Version": "2008-10-17",
                    "Id": "PolicyForCloudFrontPrivateContent",
                    "Statement": [
                        {
                            "Sid": "1",
                            "Effect": "Allow",
                            "Principal": {
                                "CanonicalUser": { "Fn::GetAtt": [ "CloudFrontOAI", "S3CanonicalUserId" ] }
                            },
                            "Action": "s3:GetObject",
                            "Resource": { "Fn::Sub": [ "${Bucket}/*", { "Bucket": { "Fn::GetAtt": [ "Data", "Arn"] } } ] }
                        }
                    ]
                }
            }
        }        
    },
    "Outputs": {
        "CloudFrontOAI": {
            "Export": {
              "Name": "StationeeringCloudFrontOAI"
            },
            "Value": { "Ref": "CloudFrontOAI" }
          }
    }
}